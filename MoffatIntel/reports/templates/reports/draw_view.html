{% extends "reports/base.html" %}

{% block title %}Draw {{ draw.name }}{% endblock %}
{% load static %}
{% load custom_filters %}

{% block content %}
<script src="{% static 'reports/deleteConfirm.js' %}"></script>
<div style="text-align: center">
    <br>
    <h1 class="center-content-block">Moffat Construction</h1>
    <h2 class="center-content-block">Draw Control Tracker</h2>
    <p class="center-content-block">Job Name: {{ project.name }}</p>
    <p class="center-content-block">Updated: {{ draw.date }}</p>
    <p class="center-content-block">Draw: #{{ draws|length }}</p>
</div>

<div class="add-new">
    <a href="{% url 'reports:new_invoice' project.id draw.id %}">+ Add Invoice</a>
</div>

{% if invoices %}
<div class="reports-list-div">
    <table width="98%" height="98%" align="center" cellpadding="10" border="0">
        <tr class="report-item headers">
            <th></th>
            <th>Invoice<br>Date</th>
            <th>Invoice<br>Number</th>
            <th>Division<br>Code</th>
            <th>Sub</th>
            <th>Method</th>
            <th>Invoice/Exhibit<br>Total</th>
            <th>W-9</th>
            <th>Description</th>
            <th>LR</th>
            <th>Lien<br>Release Type</th>
        </tr>

        {% regroup invoices by sub_id as invoice_groups %}
        {% for group in invoice_groups %}

            {% for invoice in group.list %}
                <tr class="report-item zebra">
                    {% if invoice.invoice_pdf %}
                    <td width="fit-content"><a href="{% url 'reports:invoice_view' invoice.id %}">
                        <img src="{% static 'reports/images/pdf_icon.png' %}" height="18px" width="auto"
                            style="margin-bottom: -4px;margin-left:5px"></a></td>
                    {% else %}
                    <td width="fit-content"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                    {% endif %}
                    <td width="6%" style="text-align: center"><a href="">{{ invoice.invoice_date|date:"m/d/y" }}</a></td>
                    <td width="8%" style="text-align: center"><a href="">{{ invoice.invoice_num }}</a></td>
                    <td width="8%" style="text-align: center"><a href="">{{ invoice.division_code }}</a></td>
                    <td width="10%"><a href="">{{ invoice.sub_id }}</a></td>
                    <td width="6%" style="text-align: center"><a href="">{{ invoice.get_method_display }}</a></td>
                    <td width="10%"><a href="">${{ invoice.invoice_total|floatformat:2 }}</a></td>
                    <td width="8%" style="text-align: center"><a href="">{{ invoice.w9 }}</a></td>
                    <td width="25%">{{ invoice.description }}</td>
                    {% if invoice.lien_release_pdf and invoice.signed %}
                    <td width="fit-content"><a href=""><img src="{% static 'reports/images/pdf_icon.png' %}"
                                height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                    {% elif invoice.lien_release_pdf and not invoice.signed %}
                    <td width="fit-content"><a href=""><img src="{% static 'reports/images/unsigned.png' %}"
                                height="20px" width="auto" style="margin-bottom: 0px;margin-left:4px"></a></td>
                    {% else %}
                    <td width="fit-content"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                    {% endif %}
                    <td width="7.8%" style="text-align: center"><a href="">{{ invoice.get_lien_release_type_display }}</a>
                    </td>
                    <td width="fit-content" style="text-align: center"><a
                            href="{% url 'reports:edit_invoice' project.id draw.id invoice.id %}">
                            <img src="{% static 'reports/images/pencil.png' %}" height="18px" width="auto"
                                style="margin-bottom: -4px; margin-right: 2px"></a></td>
                    <td width="fit-content" style="text-align: center">
                        <form id="delete-form" method="post"
                            data-delete-url="{% url 'reports:delete_invoice' project.id draw.id invoice.id %}">
                            {% csrf_token %}
                            <input type="hidden" name="draw_id" value="{{ draw.id }}">
                            <input type="hidden" name="username" id="username">
                            <button class="inline-delete-button" type="button" onclick="deleteConfirmation(this)">
                                <img src="{% static 'reports/images/trash.png' %}" height="15px" width="auto">
                            </button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            <tr class="report-item sub-total">
                <td colspan="6" style="text-align: right;">Subtotal for {{ group.list.0.sub_id.name }}:</td>
                <td style="text-align: left; background-color: #7c0300ba; color: white; font-weight: bold; font-size: 20px">
                    ${{ group.list|sum_values:"invoice_total"|floatformat:2 }}</td>
                <td colspan="4"></td>
            </tr>
        {% endfor %}


        <tr class="report-item sub-total">
            <td colspan="10" style="text-align: right;">Total:</td>
            <td style="text-align: left; background-color: #7c0300ba; color: white; font-weight: bold; font-size: 20px">
                ${{ invoices|sum_values:"invoice_total"|floatformat:2 }}</td>

            <td colspan="4"></td>
        </tr>
    </table>
</div>

{% else %}
<div class="reports-list-div">
    <table>
        <tr>
            <td>There are currently no invoices available.</td>
        </tr>
    </table>
</div>
{% endif %}
{% endblock %}
