{% extends "reports/base.html" %}

{% block title %}Draw {{ draw.name }}{% endblock %}
{% load static %}
{% load custom_filters %}

{% block content %}
<script src="{% static 'reports/deleteConfirm.js' %}"></script>
<div style="text-align: center">
    <br>
    <h1 class="center-content-block">Moffat Construction</h1>
    <h2 class="center-content-block">Draw Control Tracker</h2>
    <p class="center-content-block">Job Name: {{ project.name }}</p>
    <p class="center-content-block">Updated: {{ draw.date }}</p>
    <p class="center-content-block">Draw: #{{ draws|length }}</p>
</div>

<div class="add-new">
    <a href="{% url 'reports:new_invoice' project.id draw.id %}">+ Add Invoice</a>
</div>

{% if invoices %}
<div class="reports-list-div">
    <table width="98%" height="98%" align="center" cellpadding="4" border="0">
        <tr class="report-item headers" style="font-size: 12px">
            <th></th>
            <th>Invoice<br>Date</th>
            <th>Invoice<br>#</th>
            <th>Div<br>Code</th>
            <th>Category</th>
            <th>Sub/Vendor</th>
            <th>Method</th>
            <th>Invoice<br>Total</th>
            <th>W-9</th>
            <th>Description</th>
            <th>LR</th>
            <th>LR Type</th>
            <th></th>
            <th>Check Date</th>
            <th>Check #</th>
            <th>Check Total</th>
            <th>Distributed</th>
            <th></th>
            <th></th>
            <th></th>
        </tr>

        {% if groups %}
            {% for group in groups %}
                <tr class="report-item no-hover">
                    <td colspan="20" class="group-row">
                        {{group.name}}
                    </td>
                </tr>

                {% if group.subgroup_set.all.exists %}
                    {% for subgroup in group.subgroup_set.all %}
                        <tr class="report-item no-hover">
                            <td colspan="20" class="group-row-secondary">
                                {{subgroup.name}}
                            </td>
                        </tr>
                        {% regroup invoices by sub_id as invoice_sub_groups %}
                        {% for sub_group in invoice_sub_groups %}

                            {% for invoice in sub_group.list %}

                                {% if invoice.group_id == group and invoice.subgroup_id == subgroup %}
                                    <tr class="report-item zebra" style="font-size: 12px">
                                        {% if invoice.invoice_pdf %}
                                            <td width="2%">
                                                <a href="{% url 'reports:invoice_view' invoice.id %}">
                                                    <img src="{% static 'reports/images/pdf_icon.png' %}" height="18px" width="auto"
                                                        style="margin-bottom: -4px;margin-left:5px">
                                                </a>
                                            </td>
                                        {% else %}
                                            <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                                    height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                                        {% endif %}
                                        <td width="1%" style="text-align: center; white-space: nowrap;"><a href="">{{ invoice.invoice_date|date:"m/d/y" }}</a></td>
                                        <td width="1" style="text-align: center; white-space: nowrap"><a href="">{{ invoice.invoice_num }}</a></td>
                                        <td width="1%" style="text-align: center; white-space: nowrap"><a href="">{{ invoice.csi }}</a></td>
                                        <td width="7%" style="text-align: center;"><a href="">{{ invoice.get_long_category }}</a></td>
                                        <td width="5%" style="text-align: center; white-space: nowrap; margin-left: 5px; margin-right: 5px;"><a href="">{% if invoice.sub_id %}{{ invoice.sub_id }}{% endif %}{% if invoice.vendor_id %}{{invoice.vendor_id}}{% endif %}</a></td>
                                        <td width="5%" style="text-align: center"><a href="">{{ invoice.get_method_display_long }}</a></td>
                                        <td width="7.5%" style="text-align: right"><a href="">${{ invoice.invoice_total|floatformat:2 }}</a></td>
                                        <td width="4%" style="text-align: center; white-space: nowrap;"><a href="">{{ invoice.w9 }}</a></td>
                                        <td width="15%" style="font-size: 10px; white-space: normal">{{ invoice.description }}</td>

                                        {% if invoice.check_set.exists %}
                                            {% for check in invoice.check_set.all %}
                                                {% if check.lien_release_pdf and check.signed %}
                                                    <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon.png' %}"
                                                        height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                                                {% elif check.lien_release_pdf and not check.signed %}
                                                    <td width="2%"><a href=""><img src="{% static 'reports/images/unsigned.png' %}"
                                                        height="20px" width="auto" style="margin-bottom: 0px;margin-left:4px"></a></td>
                                                {% else %}
                                                    <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                                        height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                                                {% endif %}

                                                <td width="7.8%" style="text-align: center"><a href="">{{ check.get_LR_type_display_long }}</a></td>
                                                <td width="fit-content">
                                                    <a href="{% url 'reports:check_view' check.id %}">
                                                        <img src="{% static 'reports/images/pdf_icon.png' %}" height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px">
                                                    </a>
                                                </td>
                                                <td width="6%" style="text-align: center">{{ check.check_date|date:"m/d/y" }}</td>
                                                <td width="1%" style="text-align: center; white-space: nowrap">{{ check.check_num }}</td>
                                                <td width="7%" style="text-align: right"><a href="">${{ check.check_total|floatformat:2 }}</a></td>
                                                <td width="12%"><a href="">{{ check.distributed }}</a></td>
                                            {% endfor %}

                                        {% else %}
                                            <td colspan="8">
                                                <div class="add-new" style="padding: 2px; margin: 0; float: left">
                                                    <a href="{% url 'reports:new_check' project.id draw.id invoice.id %}" style="font-size: 14px">+ Add Check</a>
                                                </div>
                                            </td>
                                        {% endif %}

                                        {% if invoice.check_set.exists %}
                                            <td>
                                                <div class="add-new" style="padding: 2px; margin: 0; margin-right: 4px">
                                                    <a href="{% url 'reports:new_check' project.id draw.id invoice.id %}" style="font-size: 14px; margin-left: 4px; margin-right: 4px">+</a>
                                                </div>
                                            </td>
                                        {% endif %}
                                        <td width="fit-content" style="text-align: center">
                                        <a href="{% url 'reports:edit_invoice' project.id draw.id invoice.id %}">
                                            <img src="{% static 'reports/images/pencil.png' %}" height="18px" width="auto"
                                                style="margin-bottom: -4px; margin-right: 2px">
                                        </a>
                                        </td>
                                        <td width="fit-content" style="text-align: center">
                                            <form id="delete-form" method="post"
                                                data-delete-url="{% url 'reports:delete_invoice' project.id draw.id invoice.id %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="draw_id" value="{{ draw.id }}">
                                                <input type="hidden" name="username" id="username">
                                                <button class="inline-delete-button" type="button" onclick="deleteConfirmation(this)">
                                                    <img src="{% static 'reports/images/trash.png' %}" height="15px" width="auto">
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                            <!--
                             <tr class="report-item sub-total no-hover">
                                <td colspan="7" style="text-align: right;">Subtotal for {% if sub_group.list.0.sub_id %}{{ sub_group.list.0.sub_id.name }}{% endif %}{% if sub_group.list.0.vendor_id %}{{ sub_group.list.0.vendor_id.name }}{% endif %}:</td>
                                <td style="text-align: right; background-color: #7c0300ba; color: white; font-weight: bold; font-size: 20px">
                                    ${{ sub_group.list|sum_values:"invoice_total"|floatformat:2 }}</td>
                                <td colspan="12"></td>
                            </tr>
                            -->
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    {% regroup invoices by sub_id as invoice_sub_groups %}
                    {% for sub_group in invoice_sub_groups %}

                        {% for invoice in sub_group.list %}
                            {% if invoice.group_id == group.id %}

                                <tr class="report-item zebra" style="font-size: 12px">
                                    {% if invoice.invoice_pdf %}
                                        <td width="2%">
                                            <a href="{% url 'reports:invoice_view' invoice.id %}">
                                                <img src="{% static 'reports/images/pdf_icon.png' %}" height="18px" width="auto"
                                                    style="margin-bottom: -4px;margin-left:5px">
                                            </a>
                                        </td>
                                    {% else %}
                                        <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                                height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                                    {% endif %}
                                    <td width="1%" style="text-align: center; white-space: nowrap;"><a href="">{{ invoice.invoice_date|date:"m/d/y" }}</a></td>
                                    <td width="1" style="text-align: center; white-space: nowrap"><a href="">{{ invoice.invoice_num }}</a></td>
                                    <td width="1%" style="text-align: center; white-space: nowrap"><a href="">{{ invoice.csi }}</a></td>
                                    <td width="7%" style="text-align: center;"><a href="">{{ invoice.get_long_category }}</a></td>
                                    <td width="5%" style="text-align: center; white-space: nowrap; margin-left: 5px; margin-right: 5px;"><a href="">{% if invoice.sub_id %}{{ invoice.sub_id }}{% endif %}{% if invoice.vendor_id %}{{invoice.vendor_id}}{% endif %}</a></td>
                                    <td width="5%" style="text-align: center"><a href="">{{ invoice.get_method_display_long }}</a></td>
                                    <td width="7.5%" style="text-align: right"><a href="">${{ invoice.invoice_total|floatformat:2 }}</a></td>
                                    <td width="4%" style="text-align: center; white-space: nowrap;"><a href="">{{ invoice.w9 }}</a></td>
                                    <td width="15%" style="font-size: 10px; white-space: normal">{{ invoice.description }}</td>

                                    {% if invoice.check_set.exists %}
                                        {% for check in invoice.check_set.all %}
                                            {% if check.lien_release_pdf and check.signed %}
                                                <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon.png' %}"
                                                    height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                                            {% elif check.lien_release_pdf and not check.signed %}
                                                <td width="2%"><a href=""><img src="{% static 'reports/images/unsigned.png' %}"
                                                    height="20px" width="auto" style="margin-bottom: 0px;margin-left:4px"></a></td>
                                            {% else %}
                                                <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                                    height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                                            {% endif %}

                                            <td width="7.8%" style="text-align: center"><a href="">{{ check.get_LR_type_display_long }}</a></td>
                                            <td width="fit-content">
                                                <a href="{% url 'reports:check_view' check.id %}">
                                                    <img src="{% static 'reports/images/pdf_icon.png' %}" height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px">
                                                </a>
                                            </td>
                                            <td width="6%" style="text-align: center">{{ check.check_date|date:"m/d/y" }}</td>
                                            <td width="1%" style="text-align: center; white-space: nowrap">{{ check.check_num }}</td>
                                            <td width="7%" style="text-align: right"><a href="">${{ check.check_total|floatformat:2 }}</a></td>
                                            <td width="12%"><a href="">{{ check.distributed }}</a></td>
                                        {% endfor %}

                                    {% else %}
                                        <td colspan="8">
                                            <div class="add-new" style="padding: 2px; margin: 0; float: left">
                                                <a href="{% url 'reports:new_check' project.id draw.id invoice.id %}" style="font-size: 14px">+ Add Check</a>
                                            </div>
                                        </td>
                                    {% endif %}

                                    {% if invoice.check_set.exists %}
                                        <td>
                                            <div class="add-new" style="padding: 2px; margin: 0; margin-right: 4px">
                                                <a href="{% url 'reports:new_check' project.id draw.id invoice.id %}" style="font-size: 14px; margin-left: 4px; margin-right: 4px">+</a>
                                            </div>
                                        </td>
                                    {% endif %}
                                    <td width="fit-content" style="text-align: center">
                                    <a href="{% url 'reports:edit_invoice' project.id draw.id invoice.id %}">
                                        <img src="{% static 'reports/images/pencil.png' %}" height="18px" width="auto"
                                            style="margin-bottom: -4px; margin-right: 2px">
                                    </a>
                                    </td>
                                    <td width="fit-content" style="text-align: center">
                                        <form id="delete-form" method="post"
                                            data-delete-url="{% url 'reports:delete_invoice' project.id draw.id invoice.id %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="draw_id" value="{{ draw.id }}">
                                            <input type="hidden" name="username" id="username">
                                            <button class="inline-delete-button" type="button" onclick="deleteConfirmation(this)">
                                                <img src="{% static 'reports/images/trash.png' %}" height="15px" width="auto">
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        <!--
                        <tr class="report-item sub-total no-hover">
                            <td colspan="7" style="text-align: right;">Subtotal for {% if sub_group.list.0.sub_id %}{{ sub_group.list.0.sub_id.name }}{% endif %}{% if sub_group.list.0.vendor_id %}{{ sub_group.list.0.vendor_id.name}}{% endif %}:</td>
                            <td style="text-align: right; background-color: #7c0300ba; color: white; font-weight: bold; font-size: 20px">
                                ${{ sub_group.list|sum_values:"invoice_total"|floatformat:2 }}</td>
                            <td colspan="12"></td>
                        </tr>
                        -->
                    {% endfor %}
                {% endif %}
            {% endfor %}
        {% else %}
            {% regroup invoices by sub_id as invoice_sub_groups %}
            {% for sub_group in invoice_sub_groups %}

                {% for invoice in sub_group.list %}
                    <tr class="report-item zebra" style="font-size: 12px">
                        {% if invoice.invoice_pdf %}
                            <td width="2%">
                                <a href="{% url 'reports:invoice_view' invoice.id %}">
                                    <img src="{% static 'reports/images/pdf_icon.png' %}" height="18px" width="auto"
                                        style="margin-bottom: -4px;margin-left:5px">
                                </a>
                            </td>
                        {% else %}
                            <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                    height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                        {% endif %}
                        <td width="1%" style="text-align: center; white-space: nowrap;"><a href="">{{ invoice.invoice_date|date:"m/d/y" }}</a></td>
                        <td width="1" style="text-align: center; white-space: nowrap"><a href="">{{ invoice.invoice_num }}</a></td>
                        <td width="1%" style="text-align: center; white-space: nowrap"><a href="">{{ invoice.csi }}</a></td>
                        <td width="7%" style="text-align: center;"><a href="">{{ invoice.get_long_category }}</a></td>
                        <td width="5%" style="text-align: center; white-space: nowrap; margin-left: 5px; margin-right: 5px;"><a href="">{% if invoice.sub_id %}{{ invoice.sub_id }}{% endif %}{% if invoice.vendor_id %}{{invoice.vendor_id}}{% endif %}</a></td>
                        <td width="5%" style="text-align: center"><a href="">{{ invoice.get_method_display_long }}</a></td>
                        <td width="7.5%" style="text-align: right"><a href="">${{ invoice.invoice_total|floatformat:2 }}</a></td>
                        <td width="4%" style="text-align: center; white-space: nowrap;"><a href="">{{ invoice.w9 }}</a></td>
                        <td width="15%" style="font-size: 10px; white-space: normal">{{ invoice.description }}</td>

                        {% if invoice.check_set.exists %}
                            {% for check in invoice.check_set.all %}
                                {% if check.lien_release_pdf and check.signed %}
                                    <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon.png' %}"
                                        height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                                {% elif check.lien_release_pdf and not check.signed %}
                                    <td width="2%"><a href=""><img src="{% static 'reports/images/unsigned.png' %}"
                                        height="20px" width="auto" style="margin-bottom: 0px;margin-left:4px"></a></td>
                                {% else %}
                                    <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                        height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px"></a></td>
                                {% endif %}

                                <td width="7.8%" style="text-align: center"><a href="">{{ check.get_LR_type_display_long }}</a></td>
                                <td width="fit-content">
                                    <a href="{% url 'reports:check_view' check.id %}">
                                        <img src="{% static 'reports/images/pdf_icon.png' %}" height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px">
                                    </a>
                                </td>
                                <td width="6%" style="text-align: center">{{ check.check_date|date:"m/d/y" }}</td>
                                <td width="1%" style="text-align: center; white-space: nowrap">{{ check.check_num }}</td>
                                <td width="7%" style="text-align: right"><a href="">${{ check.check_total|floatformat:2 }}</a></td>
                                <td width="12%"><a href="">{{ check.distributed }}</a></td>
                            {% endfor %}

                        {% else %}
                            <td colspan="8">
                                <div class="add-new" style="padding: 2px; margin: 0; float: left">
                                    <a href="{% url 'reports:new_check' project.id draw.id invoice.id %}" style="font-size: 14px">+ Add Check</a>
                                </div>
                            </td>
                        {% endif %}

                        {% if invoice.check_set.exists %}
                            <td>
                                <div class="add-new" style="padding: 2px; margin: 0; margin-right: 4px">
                                    <a href="{% url 'reports:new_check' project.id draw.id invoice.id %}" style="font-size: 14px; margin-left: 4px; margin-right: 4px">+</a>
                                </div>
                            </td>
                        {% endif %}
                        <td width="fit-content" style="text-align: center">
                        <a href="{% url 'reports:edit_invoice' project.id draw.id invoice.id %}">
                            <img src="{% static 'reports/images/pencil.png' %}" height="18px" width="auto"
                                style="margin-bottom: -4px; margin-right: 2px">
                        </a>
                        </td>
                        <td width="fit-content" style="text-align: center">
                            <form id="delete-form" method="post"
                                data-delete-url="{% url 'reports:delete_invoice' project.id draw.id invoice.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="draw_id" value="{{ draw.id }}">
                                <input type="hidden" name="username" id="username">
                                <button class="inline-delete-button" type="button" onclick="deleteConfirmation(this)">
                                    <img src="{% static 'reports/images/trash.png' %}" height="15px" width="auto">
                                </button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                <!--
                <tr class="report-item sub-total no-hover">
                    <td colspan="7" style="text-align: right;">Subtotal for {% if sub_group.list.0.sub_id %}{{ sub_group.list.0.sub_id.name }}{% endif %}{% if sub_group.list.0.vendor_id %}{{ sub_group.list.0.vendor_id.name}}{% endif %}:</td>
                    <td style="text-align: right; background-color: #7c0300ba; color: white; font-weight: bold; font-size: 20px">
                        ${{ sub_group.list|sum_values:"invoice_total"|floatformat:2 }}</td>
                    <td colspan="12"></td>
                </tr>
                -->
            {% endfor %}
        {% endif %}

        <tr class="report-item sub-total no-hover">
            <td colspan="7" style="text-align: right; font-weight: bold">Total:</td>
            <td style="text-align: right; background-color: #7c0300ba; color: white; font-weight: bold; font-size: 20px">
                ${{ invoices|sum_values:"invoice_total"|floatformat:2 }}</td>

            <td colspan="7" style="text-align: right; font-weight: bold">Check Total:</td>
            <td style="text-align: right; background-color: #7c0300ba; color: white; font-weight: bold; font-size: 20px">
                ${{ checks|sum_values:"check_total"|floatformat:2 }}</td>
            <td colspan="4"></td>
        </tr>
    </table>
</div>

{% else %}
<div class="reports-list-div">
    <table>
        <tr>
            <td>There are currently no invoices available.</td>
        </tr>
    </table>
</div>
{% endif %}
{% endblock %}
