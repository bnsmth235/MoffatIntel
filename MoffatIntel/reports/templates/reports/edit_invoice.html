{% extends "reports/base.html" %}

{% block title %}Edit Invoice{% endblock %}

{% load static %}
{% block content %}
<script src="{% static 'reports/deleteConfirm.js' %}"></script>

    <form action="{% url 'reports:edit_invoice' project.id draw.id invoice.id%}" enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <fieldset class="fieldset" style="margin-left: 150px; margin-right: 150px">
            <legend><h1>Edit Invoice {{invoice.invoice_num}}</h1></legend>

            {% if error_message %}
                <p><strong class="error">{{ error_message }}</strong></p>
            {% endif %}

            <div style="display: inline-block">
                <label for="invoice_date">Invoice Date:</label>
                <input type="date" name="invoice_date" id="invoice_date" class="input-field" value='{{invoice.invoice_date|date:"Y-m-d"}}'>
            </div>

            <div style="display: inline-block">
                <label for="invoice_num">Invoice Number:</label>
                <input type="text" name="invoice_num" id="invoice_num" class="input-field" value="{{invoice.invoice_num}}">
            </div>

            <div style="display: inline-block">
                <label for="csi">CSI Division:</label>
                <select name="csi" id="csi" class="input-field">
                    {% if subselect %}<option hidden="hidden" value="{{ invoice.csi.0 }}" {% if csi.0 == subselect.csi %}selected{% endif %}>{{ subselect.get_long_csi }}</option>{% endif %}
                    {% if vendorselect %}<option hidden="hidden" value="{{ invoice.csi.0 }}" {% if csi.0 == vendorselect.csi %}selected{% endif %}>{{ vendorselect.get_long_csi }}</option>{% endif %}
                    <option value="1">General Requirement</option>
                    <option value="2">Site Works</option>
                    <option value="3">Concrete</option>
                    <option value="4">Masonry</option>
                    <option value="5">Metals</option>
                    <option value="6">Wood and Plastics</option>
                    <option value="7">Thermal and Moisture Protection</option>
                    <option value="8">Doors and Windows</option>
                    <option value="9">Finishes</option>
                    <option value="10">Specialties</option>
                    <option value="11">Equipment</option>
                    <option value="12">Furnishings</option>
                    <option value="13">Special Construction</option>
                    <option value="14">Conveying Systems</option>
                    <option value="15">Mechanical/Plumbing</option>
                    <option value="16">Electrical</option>
                </select>
            </div>

            <div style="display: inline-block">
                <label for="category">Category:</label>
                <select name="category" id="category" class="input-field">
                    {% if subselect %}<option hidden="hidden" value="{{ invoice.category.0 }}" {% if invoice.category.0 == subselect.category %}selected{% endif %}>{{ subselect.get_long_category }}</option>{% endif %}
                    {% if vendorselect %}<option hidden="hidden" value="{{ invoice.category.0 }}" {% if invoice.category.0 == vendorselect.category %}selected{% endif %}>{{ vendorselect.get_long_category }}</option>{% endif %}
                    <option value="1">Civil Engineering</option>
                    <option value="2">Architecture</option>
                    <option value="3">Electrical Engineering</option>
                    <option value="4">Mechanical Engineering</option>
                    <option value="5">Plumbing</option>
                    <option value="6">Environmental</option>
                    <option value="7">Health Department</option>
                    <option value="8">Amenities</option>
                    <option value="9">Landscape</option>
                </select>
            </div>


            <div style="display: inline-block">
                <label for="method">Method:</label>
                <select name="method" id="method" class="input-field">
                    <option hidden="hidden" value="{{invoice.method}}">{{invoice.get_method_display_long}}</option>
                    {% for choice in method_choices %}
                        <option value="{{ choice.0 }}">
                            {{ choice.1 }}
                        </option>
                    {% endfor %}
                </select>
            </div>


            <div style="display: inline-block">
                <label for="sub">Vendor/Subcontractor: </label>
                <select name="sub" id="sub" class="input-field">
                    {% if subselect %}<option hidden="hidden">{{subselect.name}}</option>{% endif %}
                    {% for sub in subs %}
                        <option>{{sub.name}}</option>
                    {% endfor %}
                    {% for vendor in vendors %}
                        <option>{{vendor.name}}</option>
                    {% endfor %}
                </select>
            </div>


            <div style="display: inline-block">
                <label for="group">Group:</label>
                <select name="group" id="groupSelect" class="input-field">
                    {% for group in groups %}
                        <option value="{{group.id}}" {% if group.id == invoice.group_id.id %}selected{% endif %}>
                            {{group.name}}
                        </option>
                    {% endfor %}
                    <option value="None">None</option>
                </select>
            </div>


            <div style="display: inline-block">
                <label for="subgroup">Subgroup:</label>
                <select name="subgroup" id="subgroupSelect" class="input-field">
                    <option value="None">None</option>
                    {% for subgroup in subgroups %}
                        <option value="{{ subgroup.id }}" {% if subgroup.id == invoice.subgroup_id.id %}selected{% endif %}>
                            {{ subgroup.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>


            <div style="display: inline-block">
                <label for="invoice_total">Invoice Total: $</label>
                <input type="number" min="0" step=".01" name="invoice_total" id="invoice_total" value="{{invoice.invoice_total|floatformat:2}}" class="input-field">
            </div>

            <div style="display: inline-block">
                <label for="description">Description:</label>
                <input type="text" name="description" id="description" class="input-field" value="{{invoice.description}}" style="width: 800px">
            </div>

            <div class="form-field">
                <label style="position: relative">Invoice PDF: </label>
                <input type="file" name="invoice_pdf" id="invoice_pdf" class="input-field" value="{{invoice.invoice_pdf}}">
                {% if invoice.invoice_pdf %}
                    <p>Current file: {{invoice.invoice_pdf.name}}</p>
                {% endif %}
            </div>


            <input class="input-field-save" type="submit" name="submit" value="Save">

        </fieldset>
    </form>
    <br><br>
    {% if invoice.check_set.all|length > 0 %}
    <fieldset class="fieldset" style="margin-left: 150px; margin-right: 150px">
        <legend><h1>Edit Checks</h1></legend>

            <div class="reports-list-div">
                <table width="100%" height="100%" align="center" cellpadding="4" border="0">
                    <tr class="report-item headers">
                        <th>LR</th>
                        <th>LR Type</th>
                        <th></th>
                        <th>Check Date</th>
                        <th>Check #</th>
                        <th>Check Total</th>
                        <th>Distributed</th>
                        <th></th>
                        <th></th>
                    </tr>
                    {% for check in invoice.check_set.all %}
                        <tr class="report-item zebra">
                            {% if invoice.check_set.exists %}
                                {% for check in invoice.check_set.all %}
                                    {% if check.lien_release_pdf and check.signed %}
                                        <td width="2%"><a href=""><img src="{% static 'reports/images/pdf_icon.png' %}"
                                            height="18px" width="auto" style="margin-bottom: -4px;margin-left:6px"></a></td>
                                    {% elif check.lien_release_pdf and not check.signed %}
                                        <td width="2%"><a href=""><img src="{% static 'reports/images/unsigned.png' %}"
                                            height="20px" width="auto" style="margin-bottom: 0px;margin-left:6px"></a></td>
                                    {% else %}
                                        <td width="2%" style="text-align: center"><a href=""><img src="{% static 'reports/images/pdf_icon_red.png' %}"
                                            height="18px" width="auto" style="margin-bottom: -4px;margin-left:10px"></a></td>
                                    {% endif %}

                                    <td width="10%" style="text-align: center"><a href="">{{ check.get_LR_type_display_long }}</a></td>
                                    <td width="2%">
                                        <a href="{% url 'reports:check_view' check.id %}">
                                            <img src="{% static 'reports/images/pdf_icon.png' %}" height="18px" width="auto" style="margin-bottom: -4px;margin-left:5px">
                                        </a>
                                    </td>
                                    <td width="10%" style="text-align: center">{{ check.check_date|date:"m/d/y" }}</td>
                                    <td width="10%" style="text-align: center;">{{ check.check_num }}</td>
                                    <td width="10%" style="text-align: right"><a href="">${{ check.check_total|floatformat:2 }}</a></td>
                                    <td width="20%"><a href="">{{ check.distributed }}</a></td>
                                {% endfor %}

                            {% else %}
                                <td colspan="9">
                                    <div class="add-new" style="padding: 2px; margin: 0; float: left">
                                        <a href="{% url 'reports:new_check' project.id draw.id invoice.id %}" style="font-size: 14px">+ Add Check</a>
                                    </div>
                                </td>
                            {% endif %}

                            <td width="5%" style="text-align: center">
                            <a href="{% url 'reports:edit_check' check.id%}">
                                <img src="{% static 'reports/images/pencil.png' %}" height="18px" width="auto"
                                    style="margin-bottom: -4px; margin-right: 2px"> Edit
                            </a>
                            </td>
                            <td width="5%" style="text-align: center">
                                <form id="delete-form" method="post"
                                    data-delete-url="{% url 'reports:delete_check' check.id%}">
                                    {% csrf_token %}
                                    <input type="hidden" name="check_id" value="{{ check.id }}">
                                    <input type="hidden" name="username" id="username">
                                    <button class="inline-delete-button" type="button" onclick="deleteConfirmation(this)">
                                        <img src="{% static 'reports/images/trash.png' %}" height="15px" width="auto"> Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </table>

            </div>
    </fieldset>
    {% endif %}

<script>
    const groupSelect = document.getElementById('groupSelect');
    const subgroupSelect = document.getElementById('subgroupSelect');
    const groups = JSON.parse('{{ groups_json | escapejs }}');

    function populateSubgroups(selectedGroupIndex) {
        subgroupSelect.innerHTML = '';

        const selectedGroup = groups[selectedGroupIndex];

        const noneOption = document.createElement('option');
        noneOption.value = 'None';
        noneOption.textContent = 'None';
        subgroupSelect.appendChild(noneOption);

        selectedGroup.subgroups.forEach(subgroup => {
            const option = document.createElement('option');
            option.value = subgroup.id;
            option.textContent = subgroup.name;
            subgroupSelect.appendChild(option);
        });
    }

    groupSelect.addEventListener('change', () => {
        const selectedGroupIndex = groupSelect.selectedIndex;
        console.log("Change")
        populateSubgroups(selectedGroupIndex);
    });

    // Call the function initially with the default selected group index
    const defaultSelectedGroupIndex = groupSelect.selectedIndex;
    populateSubgroups(defaultSelectedGroupIndex);
</script>

{% endblock %}