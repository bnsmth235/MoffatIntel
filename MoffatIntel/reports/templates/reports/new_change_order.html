{% extends "reports/base.html" %}
{% block title %}New Change Order{% endblock %}
{% load static %}

{% block content %}

<script src="{% static 'reports/deleteConfirm.js' %}" xmlns:v-on="http://www.w3.org/1999/xhtml"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<div id="app">
    <form action="{% url 'reports:change_orders' project.id sub.id %}" method="post">
        {% csrf_token %}
        <fieldset class="fieldset">
            <legend><h1>New Change Order</h1></legend>

            {% if error_message %}
                <p><strong class="error">{{ error_message }}</strong></p>
            {% endif %}

            <div class="reports-list-div">
                <table width="98%" height="98%" align="center" cellpadding="10" border="0" style="margin-bottom:20px">
                    <tr class="report-item headers">
                        <th width="5%">Number</th>
                        <th>Scope of Work</th>
                        <th width="5%">Qty</th>
                        <th width="15%">Unit Price</th>
                        <th width="10%">Total</th>
                    </tr>

                    {% verbatim %}
                    <tr v-for="(row, rowIndex) in rows" :key="rowIndex" class="report-item" style="text-align: center">
                        <td>{{ rowIndex + 1 }}</td>
                        <td><div><input type="text" :name="'scope' + rowIndex" :id="'scope' + rowIndex" class="input-field" style="margin: 0px; width: 90%"></div></td>
                        <td><input type="number" v-model="row.qty" :name="'qty' + rowIndex" class="input-field" style="margin: 0px; width: 90%" :id="'qty' + rowIndex" step="1"></td>
                        <td>$<input type="number" v-model="row.unitPrice" :name="'unitprice' + rowIndex" class="input-field" style="margin: 0px; width: 90%" :id="'unitprice' + rowIndex" step=".01"></td>
                        <td>${{ totalPrices[rowIndex] }}</td>
                        <input hidden="hidden" :value="totalPrices[rowIndex]" :id="'totalprice' + rowIndex" :name="'totalprice' + rowIndex">
                    </tr>
                    {% endverbatim %}
                </table>
                <div style="padding-top: 1em; padding-bottom: 1em">
                    <div class="add-button">
                        <button v-on:click="removeRow()" type="button">+ Remove Row</button>
                    </div>
                    <div class="add-button">
                        <button v-on:click="addRow()" type="button">+ Add Row</button>
                    </div>
                </div>
            </div>

            <div>
                <input class="input-field-save" type="submit" name="submit" value="Save">
            </div>


        </fieldset>
    </form>
</div>

<script>
    const app = Vue.createApp({
        data() {
            return {
                rows: [
                    {
                        scope: '',
                        sub: '',
                        qty: '',
                        unitPrice: '',
                    },
                ],
            };
        },
        computed: {
            rowIndexes() {
                return this.rows.map((_, index) => index);
            },
            totalPrices() {
                return this.rows.map((row) => {
                    const qty = parseFloat(row.qty) || 0;
                    const unitPrice = parseFloat(row.unitPrice) || 0;
                    return (qty * unitPrice).toFixed(2);
                });
            },
        },
        mounted() {
            const form = document.querySelector('form');
            form.addEventListener('keydown', this.handleFormKeyDown);
        },
        beforeUnmount() {
            const form = document.querySelector('form');
            form.removeEventListener('keydown', this.handleFormKeyDown);
        },
        methods: {
            addRow() {
                this.rows.push({
                    scope: '',
                    sub: '',
                    qty: '',
                    unitPrice: '',
                });
            },
            removeRow() {
                if (this.rows.length > 1) {
                    this.rows.pop();
                }
            },
            handleFormKeyDown(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                }
            },
        },
    });

    const vm = app.mount("#app");
</script>

{% endblock %}
